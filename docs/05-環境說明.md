# 環境說明 (開發 vs 部署)

## 環境類型概述

本專案支援多種執行環境，每種環境都有不同的配置和用途：

1. **開發環境 (Development)** - 本地開發和測試
2. **Docker 環境 (Docker)** - 容器化部署
3. **生產環境 (Production)** - 正式部署環境

## 根目錄 npm 指令說明

根目錄的 `package.json` 提供了便利的指令來管理整個專案：

### 開發相關指令
```bash
# 安裝所有依賴 (根目錄、前端、後端)
npm run install:all

# 僅啟動前端開發伺服器 (Vite)
npm run dev:client

# 僅啟動後端開發伺服器 (Nodemon)
npm run dev:server

# 同時啟動前後端開發伺服器
npm run dev
```

### 建置和部署指令
```bash
# 建置前端專案 (用於生產)
npm run build

# 啟動生產模式後端伺服器
npm start
```

### 資料庫管理指令
```bash
# 初始化資料庫 (建立表格和範例資料)
npm run db:init

# 清空資料庫並重新初始化
npm run db:clear

# 檢查資料庫連線狀態
npm run db:check

# 生成 SQL 檔案
npm run db:generate-sql
```

## 開發環境設定

### 適用情境
- 本地開發和除錯
- 新功能開發
- 快速原型製作

### 環境需求
- Node.js 18+
- MySQL 資料庫 (可以是本地或遠端)
- Git

### 設定步驟

1. **複製專案**
```bash
git clone <repository-url>
cd GDG-Portal
```

2. **安裝依賴**
```bash
npm run install:all
```

3. **配置環境變數**
創建 `.env` 檔案 (可從 `.env.example` 複製)：
```bash
# 資料庫設定
DB_HOST=localhost
DB_PORT=3306
DB_NAME=gdg_portal
DB_USER=your_username
DB_PASSWORD=your_password

# JWT 安全金鑰
JWT_SECRET=your-super-secret-jwt-key
COOKIE_SECRET=your-super-secret-cookie-key

# Google OAuth (開發用)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# 應用程式設定
NODE_ENV=development
PORT=3000
CLIENT_URL=http://localhost:5173
```

4. **設定資料庫**
```bash
# 檢查資料庫連線
npm run db:check

# 初始化資料庫
npm run db:init
```

5. **啟動開發伺服器**
```bash
# 同時啟動前後端
npm run dev
```

### 開發環境特色
- **熱重載** - 程式碼變更時自動重新載入
- **詳細日誌** - 顯示所有 SQL 查詢和錯誤詳情
- **CORS 設定** - 允許前端 (5173) 存取後端 (3000)
- **檔案監控** - 使用 Nodemon 監控後端檔案變更

### 開發工具
```javascript
// server/config/database.js (開發模式)
const sequelize = new Sequelize(database, username, password, {
  host: host,
  dialect: 'mysql',
  logging: console.log,        // 顯示 SQL 查詢
  define: {
    charset: 'utf8mb4',
    collate: 'utf8mb4_unicode_ci'
  }
});
```

## Docker 環境設定

### 適用情境
- 快速部署和測試
- 環境一致性保證
- 容器化部署
- 團隊協作

### 環境需求
- Docker Desktop
- Docker Compose

### 設定步驟

1. **使用一鍵部署腳本**
```bash
# Windows
.\deploy-docker.bat

# 或手動執行
docker-compose up --build -d
```

2. **環境變數配置**
Docker 環境使用 `.env.docker` 檔案：
```bash
# Docker 專用資料庫設定
DB_HOST=mysql              # Docker 服務名稱
DB_PORT=3306
DB_NAME=gdg_portal
DB_USER=gdg_admin
DB_PASSWORD=gdg_secure_2024

# 安全金鑰 (自動生成)
JWT_SECRET=docker-generated-jwt-secret
COOKIE_SECRET=docker-generated-cookie-secret

# Docker 環境設定
NODE_ENV=production
PORT=3000
CLIENT_URL=http://localhost:3000
```

### Docker 服務架構
```yaml
# docker-compose.yml
services:
  app:           # Node.js 應用程式
    ports: ["3000:3000"]
    
  mysql:         # MySQL 8.0 資料庫
    ports: ["3306:3306"]
    
  adminer:       # 資料庫管理介面
    ports: ["8080:8080"]
```

### Docker 環境特色
- **完全隔離** - 所有服務運行在容器中
- **一鍵部署** - 自動建置和啟動所有服務
- **資料持久化** - MySQL 資料存儲在 Docker volume
- **管理介面** - Adminer 提供圖形化資料庫管理

### 有用的 Docker 指令
```bash
# 查看容器狀態
docker-compose ps

# 查看應用程式日誌
docker-compose logs app

# 重新建置並啟動
docker-compose up --build -d

# 停止所有服務
docker-compose down

# 進入應用程式容器
docker-compose exec app sh

# 進入 MySQL 容器
docker-compose exec mysql mysql -u gdg_admin -p
```

## 生產環境設定

### 適用情境
- 正式網站部署
- 高可用性需求
- 安全性要求較高

### 環境需求
- Linux 伺服器 (Ubuntu/CentOS)
- Nginx 反向代理
- SSL 憑證
- 域名

### 設定步驟

1. **伺服器準備**
```bash
# 更新系統
sudo apt update && sudo apt upgrade -y

# 安裝 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 安裝 Docker Compose
sudo apt install docker-compose-plugin
```

2. **專案部署**
```bash
# 複製專案到伺服器
git clone <repository-url>
cd GDG-Portal

# 配置生產環境變數
cp .env.example .env.production
# 編輯 .env.production 設定實際的生產參數
```

3. **Nginx 配置**
```nginx
# /etc/nginx/sites-available/gdg-portal
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 生產環境變數範例
```bash
# .env.production
DB_HOST=localhost
DB_PORT=3306
DB_NAME=gdg_portal_prod
DB_USER=gdg_prod_user
DB_PASSWORD=super_secure_password_2024

JWT_SECRET=production-jwt-secret-very-long-and-secure
COOKIE_SECRET=production-cookie-secret-very-long-and-secure

GOOGLE_CLIENT_ID=your-production-google-client-id
GOOGLE_CLIENT_SECRET=your-production-google-client-secret

NODE_ENV=production
PORT=3000
CLIENT_URL=https://your-domain.com
```

### 生產環境特色
- **效能最佳化** - 壓縮靜態檔案、啟用快取
- **安全強化** - HTTPS、安全標頭、輸入驗證
- **日誌記錄** - 詳細的存取和錯誤日誌
- **監控告警** - 系統監控和異常通知

### 生產部署指令
```bash
# 生產模式啟動
NODE_ENV=production npm start

# 或使用 PM2 管理程序
npm install -g pm2
pm2 start server/index.js --name gdg-portal
pm2 startup
pm2 save
```

## 環境比較表

| 特性 | 開發環境 | Docker 環境 | 生產環境 |
|------|----------|-------------|----------|
| **啟動方式** | `npm run dev` | `docker-compose up` | `npm start` / PM2 |
| **資料庫** | 本地 MySQL | Docker MySQL | 生產 MySQL |
| **熱重載** | ✅ | ❌ | ❌ |
| **SQL 日誌** | ✅ | ✅ | ❌ |
| **HTTPS** | ❌ | ❌ | ✅ |
| **快取** | ❌ | ❌ | ✅ |
| **容器化** | ❌ | ✅ | 可選 |
| **適用場景** | 本地開發 | 測試/Demo | 正式網站 |

## 環境切換

### 從開發切換到 Docker
```bash
# 停止開發伺服器
# Ctrl+C 停止 npm run dev

# 啟動 Docker 環境
docker-compose up --build -d
```

### 從 Docker 切換到開發
```bash
# 停止 Docker 服務
docker-compose down

# 啟動開發環境
npm run dev
```

### 環境變數管理
不同環境使用不同的配置檔案：
- 開發環境：`.env`
- Docker 環境：`.env.docker`
- 生產環境：`.env.production`

## 常見問題解決

### 端口衝突
```bash
# 檢查端口占用
netstat -ano | findstr :3000
netstat -ano | findstr :5173

# 殺死佔用端口的程序
taskkill /PID <pid> /F
```

### 資料庫連線問題
```bash
# 檢查資料庫狀態
npm run db:check

# 重新初始化資料庫
npm run db:clear
```

### Docker 問題
```bash
# 重建容器 (清除快取)
docker-compose build --no-cache

# 查看容器日誌
docker-compose logs -f app

# 清理未使用的容器和映像
docker system prune -a
```

這個多環境設計確保了從開發到部署的順暢流程，每個環境都針對其特定用途進行了最佳化。
