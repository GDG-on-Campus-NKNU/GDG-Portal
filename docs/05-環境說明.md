# 環境說明 (開發 vs 部署)

## 環境類型概述

本專案支援多種執行環境，每種環境都有不同的配置和用途：

1. **開發環境 (Development)** - 本地開發和測試
2. **Docker 環境 (Docker)** - 容器化部署  
3. **生產環境 (Production)** - 正式部署環境

每個環境都有專門的配置檔案：

### 📁 **前端環境配置檔案**
```
client/
├── .env                 # 預設/fallback 環境 (開發模式)
├── .env.development     # 本地開發環境  
├── .env.docker          # Docker 部署環境
├── .env.production      # 生產環境
└── .env.example         # 範本檔案
```

### 📁 **後端環境配置檔案**
```
server/
├── .env                 # 預設/fallback 環境 (開發模式)
├── .env.development     # 本地開發環境
├── .env.docker          # Docker 部署環境
├── .env.production      # 生產環境  
└── .env.example         # 範本檔案
```

## 根目錄 npm 指令說明

根目錄的 `package.json` 提供了便利的指令來管理整個專案：

### 開發相關指令
```bash
# 安裝所有依賴 (根目錄、前端、後端)
npm run install:all

# 僅啟動前端開發伺服器 (Vite)
npm run dev:client

# 僅啟動前端開發伺服器 (Docker 模式)
npm run dev:client:docker

# 僅啟動後端開發伺服器 (Nodemon)
npm run dev:server

# 僅啟動後端開發伺服器 (Docker 模式)
npm run dev:server:docker

# 同時啟動前後端開發伺服器 (開發環境)
npm run dev

# 同時啟動前後端開發伺服器 (Docker 環境)
npm run dev:docker
```

### 建置和部署指令
```bash
# 建置前端專案 (生產環境)
npm run build

# 建置前端專案 (Docker 環境)
npm run build:docker

# 建置前端專案 (開發環境)
npm run build:dev

# 啟動生產模式後端伺服器
npm start

# 啟動 Docker 模式後端伺服器
npm run start:docker
```

### 資料庫管理指令
```bash
# 初始化資料庫 (建立表格和範例資料)
npm run db:init

# 清空資料庫並重新初始化
npm run db:clear

# 檢查資料庫連線狀態
npm run db:check

# 生成 SQL 檔案
npm run db:generate-sql
```

## 開發環境設定

### 適用情境
- 本地開發和除錯
- 新功能開發
- 快速原型製作

### 環境需求
- Node.js 18+
- MySQL 資料庫 (可以是本地或遠端)
- Git

### 設定步驟

1. **複製專案**
```bash
git clone <repository-url>
cd GDG-Portal
```

2. **安裝依賴**
```bash
npm run install:all
```

3. **配置環境變數**
現在每個環境都有專門的配置檔案：

**開發環境配置** (`server/.env.development`)：
```bash
# 後端開發環境變數
NODE_ENV=development
PORT=5000
CLIENT_URL=http://localhost:5173
OAUTH_CALLBACK_URL=http://localhost:5000/api/auth/google/redirect

# 資料庫設定 (開發環境)
DB_HOST=localhost
DB_PORT=3306
DB_NAME=gdg_portal
DB_USER=gdg_admin
DB_PASSWORD=gdg_secure_NEW_2025

# JWT 安全金鑰
JWT_SECRET=development-jwt-secret-2024-very-secure-key
JWT_REFRESH_SECRET=development-refresh-jwt-secret-2024-very-secure-key
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
COOKIE_SECRET=development-cookie-secret-2024-very-secure-key

# Google OAuth 設定
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

**前端開發環境配置** (`client/.env.development`)：
```bash
# 前端開發環境變數
NODE_ENV=development

# 後端 API 基礎 URL (開發環境)
VITE_API_BASE_URL=http://localhost:5000

# 前端應用 URL
VITE_CLIENT_URL=http://localhost:5173

# Google OAuth 客戶端 ID (開發用)
VITE_GOOGLE_CLIENT_ID=your_google_client_id_here

# 開發模式功能開關
VITE_ENABLE_DEV_TOOLS=true
VITE_SHOW_DEV_LOGIN=true

# API 代理設定 (給 Vite 使用)
VITE_PROXY_TARGET=http://localhost:5000
```

4. **設定資料庫**
```bash
# 檢查資料庫連線
npm run db:check

# 初始化資料庫
npm run db:init
```

5. **啟動開發伺服器**
```bash
# 同時啟動前後端
npm run dev
```

### 開發環境特色
- **熱重載** - 程式碼變更時自動重新載入
- **詳細日誌** - 顯示所有 SQL 查詢和錯誤詳情
- **CORS 設定** - 允許前端 (5173) 存取後端 (3000)
- **檔案監控** - 使用 Nodemon 監控後端檔案變更

### 開發工具
```javascript
// server/config/database.js (開發模式)
const sequelize = new Sequelize(database, username, password, {
  host: host,
  dialect: 'mysql',
  logging: console.log,        // 顯示 SQL 查詢
  define: {
    charset: 'utf8mb4',
    collate: 'utf8mb4_unicode_ci'
  }
});
```

### API 服務層 (前端)
新版本加入了統一的 API 服務層 (`client/src/services/apiService.js`)：

```javascript
// 使用環境變數配置的 API 服務
import { apiService, apiConfig } from '@/services/apiService';

// 自動根據環境選擇正確的 API 端點
const response = await apiService.get('/api/core-team');

// 環境配置檢查
console.log('API Base URL:', apiConfig.baseURL);
console.log('Development mode:', apiConfig.isDevelopment);
console.log('Show dev tools:', apiConfig.showDevTools);
```

**API 服務特色**：
- **環境自適應** - 自動根據 `VITE_API_BASE_URL` 選擇端點
- **統一錯誤處理** - 統一的超時和錯誤處理機制
- **開發工具支援** - 根據環境變數控制開發功能顯示

## Docker 環境設定

### 適用情境
- 快速部署和測試
- 環境一致性保證
- 容器化部署
- 團隊協作

### 環境需求
- Docker Desktop
- Docker Compose

### 設定步驟

1. **使用一鍵部署腳本**
```bash
# Windows
.\deploy-docker.bat

# 或手動執行
docker-compose up --build -d
```

2. **環境變數配置**
Docker 環境使用專門的配置檔案：

**後端 Docker 配置** (`server/.env.docker`)：
```bash
# 後端 Docker 環境變數
NODE_ENV=docker
PORT=3000
CLIENT_URL=http://localhost:3000
OAUTH_CALLBACK_URL=http://localhost:3000/api/auth/google/redirect

# 資料庫設定 (Docker 內部網路)
DB_HOST=mysql              # Docker 服務名稱
DB_PORT=3306
DB_NAME=gdg_portal
DB_USER=gdg_admin
DB_PASSWORD=gdg_secure_NEW_2025

# JWT 安全金鑰 (Docker 專用)
JWT_SECRET=docker-production-jwt-secret-2024-very-secure-key
JWT_REFRESH_SECRET=docker-production-refresh-jwt-secret-2024-very-secure-key
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
COOKIE_SECRET=docker-production-cookie-secret-2024-very-secure-key

# Google OAuth 設定
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

**前端 Docker 配置** (`client/.env.docker`)：
```bash
# 前端 Docker 環境變數
NODE_ENV=production

# 後端 API 基礎 URL (Docker 內部網路)
VITE_API_BASE_URL=http://localhost:3000

# 前端應用 URL (Docker 部署)
VITE_CLIENT_URL=http://localhost:3000

# Google OAuth 客戶端 ID (正式用)
VITE_GOOGLE_CLIENT_ID=your_google_client_id_here

# 生產模式功能開關
VITE_ENABLE_DEV_TOOLS=false
VITE_SHOW_DEV_LOGIN=false

# API 代理設定 (Docker 環境)
VITE_PROXY_TARGET=http://localhost:3000
```

### Docker 服務架構
```yaml
# docker-compose.yml
services:
  app:           # Node.js 應用程式
    ports: ["3000:3000"]
    
  mysql:         # MySQL 8.0 資料庫
    ports: ["3306:3306"]
    
  adminer:       # 資料庫管理介面
    ports: ["8080:8080"]
```

### Docker 環境特色
- **完全隔離** - 所有服務運行在容器中
- **一鍵部署** - 自動建置和啟動所有服務
- **資料持久化** - MySQL 資料存儲在 Docker volume
- **管理介面** - Adminer 提供圖形化資料庫管理

### 有用的 Docker 指令
```bash
# 查看容器狀態
docker-compose ps

# 查看應用程式日誌
docker-compose logs app

# 重新建置並啟動
docker-compose up --build -d

# 停止所有服務
docker-compose down

# 進入應用程式容器
docker-compose exec app sh

# 進入 MySQL 容器
docker-compose exec mysql mysql -u gdg_admin -p
```

## 生產環境設定

### 適用情境
- 正式網站部署
- 高可用性需求
- 安全性要求較高

### 環境需求
- Linux 伺服器 (Ubuntu/CentOS)
- Nginx 反向代理
- SSL 憑證
- 域名

### 設定步驟

1. **伺服器準備**
```bash
# 更新系統
sudo apt update && sudo apt upgrade -y

# 安裝 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 安裝 Docker Compose
sudo apt install docker-compose-plugin
```

2. **專案部署**
```bash
# 複製專案到伺服器
git clone <repository-url>
cd GDG-Portal

# 配置生產環境變數
cp .env.example .env.production
# 編輯 .env.production 設定實際的生產參數
```

3. **Nginx 配置**
```nginx
# /etc/nginx/sites-available/gdg-portal
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 生產環境變數範例

**後端生產配置** (`server/.env.production`)：
```bash
# 後端生產環境變數
NODE_ENV=production
PORT=3000
CLIENT_URL=https://your-domain.com
OAUTH_CALLBACK_URL=https://your-domain.com/api/auth/google/redirect

# 資料庫設定 (生產環境)
DB_HOST=localhost
DB_PORT=3306
DB_NAME=gdg_portal_prod
DB_USER=gdg_prod_user
DB_PASSWORD=super_secure_password_2024

# JWT 安全金鑰 (生產環境 - 必須更換)
JWT_SECRET=production-jwt-secret-very-long-and-secure
JWT_REFRESH_SECRET=production-refresh-jwt-secret-very-long-and-secure
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
COOKIE_SECRET=production-cookie-secret-very-long-and-secure

# Google OAuth 設定 (生產環境)
GOOGLE_CLIENT_ID=your-production-google-client-id
GOOGLE_CLIENT_SECRET=your-production-google-client-secret
```

**前端生產配置** (`client/.env.production`)：
```bash
# 前端生產環境變數
NODE_ENV=production

# 後端 API 基礎 URL (生產環境)
VITE_API_BASE_URL=https://your-domain.com

# 前端應用 URL (生產環境)
VITE_CLIENT_URL=https://your-domain.com

# Google OAuth 客戶端 ID (生產用)
VITE_GOOGLE_CLIENT_ID=your_production_google_client_id_here

# 生產模式功能開關
VITE_ENABLE_DEV_TOOLS=false
VITE_SHOW_DEV_LOGIN=false
```

### 生產環境特色
- **效能最佳化** - 壓縮靜態檔案、啟用快取
- **安全強化** - HTTPS、安全標頭、輸入驗證
- **日誌記錄** - 詳細的存取和錯誤日誌
- **監控告警** - 系統監控和異常通知

### 生產部署指令
```bash
# 生產模式啟動
NODE_ENV=production npm start

# 或使用 PM2 管理程序
npm install -g pm2
pm2 start server/index.js --name gdg-portal
pm2 startup
pm2 save
```

## 環境比較表

| 特性 | 開發環境 | Docker 環境 | 生產環境 |
|------|----------|-------------|----------|
| **啟動方式** | `npm run dev` | `npm run dev:docker` | `npm start` / PM2 |
| **前端端口** | 5173 (Vite) | 3000 (靜態) | 3000 (靜態) |
| **後端端口** | 5000 | 3000 | 3000 |
| **資料庫主機** | localhost | mysql (容器) | localhost |
| **熱重載** | ✅ | ❌ | ❌ |
| **SQL 日誌** | ✅ | ✅ | ❌ |
| **開發工具** | ✅ | ❌ | ❌ |
| **快速登入** | ✅ | ❌ | ❌ |
| **HTTPS** | ❌ | ❌ | ✅ |
| **快取** | ❌ | ❌ | ✅ |
| **容器化** | ❌ | ✅ | 可選 |
| **配置檔案** | `.env.development` | `.env.docker` | `.env.production` |
| **適用場景** | 本地開發 | 測試/Demo | 正式網站 |

## 環境切換

### 從開發切換到 Docker
```bash
# 停止開發伺服器
# Ctrl+C 停止 npm run dev

# 啟動 Docker 環境 (新方式)
npm run dev:docker

# 或使用 docker-compose 直接操作
docker-compose up --build -d
```

### 從 Docker 切換到開發
```bash
# 停止 Docker 服務
docker-compose down

# 啟動開發環境
npm run dev
```

### 環境變數管理
每個環境自動載入對應的配置檔案：

- **開發環境**：
  - 前端：`client/.env.development`
  - 後端：`server/.env.development`
  
- **Docker 環境**：
  - 前端：`client/.env.docker` 
  - 後端：`server/.env.docker`
  
- **生產環境**：
  - 前端：`client/.env.production`
  - 後端：`server/.env.production`

- **Fallback**：
  - 前端：`client/.env` (預設為開發模式)
  - 後端：`server/.env` (預設為開發模式)

### 環境切換指令總覽
```bash
# 開發環境
npm run dev              # 前後端同時啟動 (開發模式)
npm run dev:client       # 僅前端 (開發模式)
npm run dev:server       # 僅後端 (開發模式)

# Docker 環境  
npm run dev:docker       # 前後端同時啟動 (Docker 模式)
npm run dev:client:docker # 僅前端 (Docker 模式)
npm run dev:server:docker # 僅後端 (Docker 模式)

# 建置指令
npm run build            # 生產環境建置
npm run build:docker     # Docker 環境建置
npm run build:dev        # 開發環境建置

# 啟動指令
npm start                # 生產模式啟動
npm run start:docker     # Docker 模式啟動
```

## 常見問題解決

### 端口衝突
```bash
# 檢查端口占用
netstat -ano | findstr :3000
netstat -ano | findstr :5000
netstat -ano | findstr :5173

# 殺死佔用端口的程序
taskkill /PID <pid> /F
```

### 環境變數問題
```bash
# 檢查當前載入的環境檔案
echo $NODE_ENV                    # Linux/Mac
echo %NODE_ENV%                   # Windows

# 確認環境變數是否正確載入
npm run dev:server               # 開發環境 (應載入 .env.development)
npm run dev:server:docker        # Docker 環境 (應載入 .env.docker)
```

### 前端代理問題
如果前端無法連接到後端 API：

1. **檢查 Vite 代理設定**：
```javascript
// client/vite.config.js 會根據環境變數設定代理
console.log('Proxy target:', env.VITE_PROXY_TARGET);
```

2. **確認環境變數設定**：
```bash
# 開發環境：前端應該代理到 localhost:5000
# Docker 環境：前端應該代理到 localhost:3000
```

### 多環境配置衝突
如果遇到配置衝突：

1. **清理快取**：
```bash
# 清理前端快取
cd client && npm run build

# 清理後端 node_modules
cd server && rm -rf node_modules && npm install
```

2. **確認配置檔案優先順序**：
```
1. 特定環境檔案 (.env.development/.env.docker/.env.production)
2. 預設檔案 (.env)
3. 範本檔案 (.env.example) - 僅供參考
```

### 資料庫連線問題
```bash
# 檢查資料庫狀態
npm run db:check

# 針對特定環境初始化資料庫
NODE_ENV=development npm run db:init:dev        # Windows: set NODE_ENV=development && npm run db:init:dev:win
NODE_ENV=docker npm run db:init:docker
```

### Docker 問題
```bash
# 重建容器 (清除快取)
docker-compose build --no-cache

# 查看容器日誌
docker-compose logs -f app

# 檢查環境變數是否正確載入
docker-compose exec app env | grep NODE_ENV
docker-compose exec app env | grep DB_HOST

# 清理未使用的容器和映像
docker system prune -a
```

### 日誌系統問題
```bash
# 檢查日誌目錄是否存在
ls server/logs

# 使用日誌管理工具
cd server && node scripts/log-manager.js list
cd server && node scripts/log-manager.js stats

# 手動測試日誌寫入
curl http://localhost:5000/api/health    # 開發環境
curl http://localhost:3000/api/health    # Docker/生產環境
```

這個多環境設計確保了從開發到部署的順暢流程，每個環境都針對其特定用途進行了最佳化。
