# 資料表架構範例

## 資料庫設計概述

本專案使用 **MySQL 8.0** 作為主資料庫，配置 **utf8mb4** 字符編碼以完整支援中文字元。所有資料表都使用 **snake_case** 命名慣例，並透過 **Sequelize ORM** 進行操作。

## 核心資料表

### 1. users (使用者表)
儲存使用者的基本認證資訊。

```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  google_id VARCHAR(255) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  role ENUM('admin', 'member', 'guest') DEFAULT 'member',
  is_active BOOLEAN DEFAULT true,
  last_login DATETIME,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**範例資料：**
```sql
INSERT INTO users (google_id, email, name, role) VALUES
('123456789', 'admin@gdg.com', '管理員', 'admin'),
('987654321', 'member@gdg.com', '一般成員', 'member');
```

### 2. profiles (個人檔案表)
儲存使用者的詳細個人資訊，與 users 表一對一關聯。

```sql
CREATE TABLE profiles (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNIQUE NOT NULL,
  student_id VARCHAR(50),
  phone VARCHAR(20),
  department VARCHAR(100),
  grade VARCHAR(20),
  bio TEXT,
  github_url VARCHAR(255),
  linkedin_url VARCHAR(255),
  photo VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**範例資料：**
```sql
INSERT INTO profiles (user_id, student_id, department, bio, photo) VALUES
(1, 'A001', '資訊工程學系', '熱愛程式開發的學生', '/assets/members/admin_profile.png');
```

### 3. core_team (核心團隊表)
儲存 GDG 核心團隊成員資訊。

```sql
CREATE TABLE core_team (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNIQUE,
  name VARCHAR(255) NOT NULL,
  position VARCHAR(100) NOT NULL,
  email VARCHAR(255),
  bio TEXT,
  skills JSON,
  social_links JSON,
  photo VARCHAR(255),
  display_order INT DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  joined_date DATE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**範例資料：**
```sql
INSERT INTO core_team (name, position, email, bio, photo, display_order) VALUES
('顏榕嶙', '負責人', 'leader@gdg.com', '負責整個 GDG 社團的營運', '/assets/members/yen_profile.png', 1),
('技術長', '技術部門主管', 'tech@gdg.com', '負責技術相關活動規劃', '/assets/members/tech_lead.png', 2);
```

### 4. events (活動表)
儲存 GDG 舉辦的各種活動資訊。

```sql
CREATE TABLE events (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  content LONGTEXT,
  event_date DATETIME NOT NULL,
  registration_start DATETIME,
  registration_end DATETIME,
  location VARCHAR(255),
  max_participants INT,
  current_participants INT DEFAULT 0,
  banner_image VARCHAR(255),
  gallery_images JSON,
  tags JSON,
  organizer_id INT,
  status ENUM('draft', 'published', 'ongoing', 'completed', 'cancelled') DEFAULT 'draft',
  is_featured BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (organizer_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**範例資料：**
```sql
INSERT INTO events (title, description, event_date, location, max_participants, status) VALUES
('Git & GitHub 工作坊', '學習版本控制的基礎知識', '2024-03-15 14:00:00', '電腦教室A', 30, 'published'),
('React 前端開發分享', '現代前端框架 React 介紹', '2024-03-20 19:00:00', '會議室B', 25, 'published');
```

### 5. announcements (公告表)
儲存社團公告和最新消息。

```sql
CREATE TABLE announcements (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL,
  content LONGTEXT NOT NULL,
  summary TEXT,
  author_id INT NOT NULL,
  category ENUM('general', 'event', 'recruitment', 'urgent') DEFAULT 'general',
  priority ENUM('low', 'normal', 'high', 'urgent') DEFAULT 'normal',
  is_pinned BOOLEAN DEFAULT false,
  is_published BOOLEAN DEFAULT false,
  publish_date DATETIME,
  expire_date DATETIME,
  view_count INT DEFAULT 0,
  thumbnail VARCHAR(255),
  tags JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**範例資料：**
```sql
INSERT INTO announcements (title, content, author_id, category, is_published) VALUES
('歡迎加入 GDG on Campus', '歡迎所有新成員加入我們的大家庭！', 1, 'general', true),
('本月活動預告', '三月份我們將舉辦多場精彩活動...', 1, 'event', true);
```

### 6. gallery (相簿表)
儲存活動照片和相簿資訊。

```sql
CREATE TABLE gallery (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  image_url VARCHAR(255) NOT NULL,
  thumbnail_url VARCHAR(255),
  alt_text VARCHAR(255),
  event_id INT,
  category ENUM('event', 'team', 'workshop', 'social', 'other') DEFAULT 'other',
  tags JSON,
  photographer VARCHAR(100),
  taken_date DATETIME,
  display_order INT DEFAULT 0,
  is_featured BOOLEAN DEFAULT false,
  is_public BOOLEAN DEFAULT true,
  view_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**範例資料：**
```sql
INSERT INTO gallery (title, description, image_url, category, is_featured) VALUES
('團隊合照', 'GDG 核心團隊大合照', '/assets/gallery/team_photo_1.jpg', 'team', true),
('工作坊現場', 'Git 工作坊活動現場', '/assets/gallery/workshop_1.jpg', 'workshop', false);
```

## 資料表關聯圖

```
users (1) -----> (1) profiles
  |
  | (1)
  |
  v (n)
core_team

users (1) -----> (n) events (as organizer)
  |
  | (1)
  |
  v (n)
announcements (as author)

events (1) -----> (n) gallery
```

## 索引設計

為了提升查詢效能，在關鍵欄位上建立索引：

```sql
-- 使用者相關索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_google_id ON users(google_id);
CREATE INDEX idx_users_role ON users(role);

-- 活動相關索引
CREATE INDEX idx_events_date ON events(event_date);
CREATE INDEX idx_events_status ON events(status);
CREATE INDEX idx_events_featured ON events(is_featured);

-- 公告相關索引
CREATE INDEX idx_announcements_published ON announcements(is_published);
CREATE INDEX idx_announcements_category ON announcements(category);
CREATE INDEX idx_announcements_pinned ON announcements(is_pinned);

-- 相簿相關索引
CREATE INDEX idx_gallery_category ON gallery(category);
CREATE INDEX idx_gallery_featured ON gallery(is_featured);
CREATE INDEX idx_gallery_event ON gallery(event_id);
```

## Sequelize 模型對應

### 模型定義範例
```javascript
// server/model/userModel.js
const User = sequelize.define('User', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  google_id: {
    type: DataTypes.STRING,
    unique: true,
    allowNull: false
  },
  email: {
    type: DataTypes.STRING,
    unique: true,
    allowNull: false,
    validate: { isEmail: true }
  },
  name: {
    type: DataTypes.STRING,
    allowNull: false
  },
  role: {
    type: DataTypes.ENUM('admin', 'member', 'guest'),
    defaultValue: 'member'
  }
}, {
  tableName: 'users',
  underscored: true,  // 自動轉換為 snake_case
  timestamps: true
});
```

### 關聯定義
```javascript
// server/model/associations.js
User.hasOne(Profile, { foreignKey: 'user_id' });
Profile.belongsTo(User, { foreignKey: 'user_id' });

User.hasMany(Event, { foreignKey: 'organizer_id' });
Event.belongsTo(User, { foreignKey: 'organizer_id' });

Event.hasMany(Gallery, { foreignKey: 'event_id' });
Gallery.belongsTo(Event, { foreignKey: 'event_id' });
```

## 資料庫初始化

使用提供的初始化腳本來建立表格和插入範例資料：

```bash
# Docker 環境
docker-compose exec app node server/scripts/docker-init-database.js

# 本地環境
npm run db:init
```

## 備份與還原

### 備份資料庫
```bash
# 使用 Docker
docker-compose exec mysql mysqldump -u gdg_admin -p gdg_portal > backup.sql

# 直接使用 MySQL
mysqldump -u gdg_admin -p gdg_portal > backup.sql
```

### 還原資料庫
```bash
# 使用 Docker
docker-compose exec -i mysql mysql -u gdg_admin -p gdg_portal < backup.sql

# 直接使用 MySQL
mysql -u gdg_admin -p gdg_portal < backup.sql
```

## 效能最佳化建議

1. **使用適當的資料型別**
   - VARCHAR 長度根據實際需求設定
   - 使用 ENUM 限制選項值
   - JSON 欄位儲存結構化資料

2. **索引策略**
   - 在經常查詢的欄位建立索引
   - 避免在小表上建立過多索引
   - 定期分析查詢效能

3. **查詢最佳化**
   - 使用 include 預載入關聯資料
   - 限制查詢結果數量 (分頁)
   - 只選取需要的欄位

4. **資料維護**
   - 定期清理過期資料
   - 監控資料庫大小
   - 設定適當的備份策略
